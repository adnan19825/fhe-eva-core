name: Build and Deploy WebAssembly

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Ermöglicht manuellen Start

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # WICHTIG: Erlaubt dem Workflow, Commits durchzuführen

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
        rustup target add wasm32-unknown-unknown

    - name: Install wasm-pack
      run: cargo install wasm-pack

    - name: Build WebAssembly
      run: wasm-pack build --release --target web

    - name: Deploy WASM files to repository
      run: |
        # Lösche alte Dateien im wasm/ Ordner (falls vorhanden)
        rm -rf wasm/*
        # Kopiere die neu gebauten Dateien
        cp pkg/*.wasm pkg/*.js wasm/
        # Zeige, was kopiert wurde
        ls -la wasm/

        # Konfiguriere Git und committe die Änderungen
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add wasm/
        
        # Prüfe, ob es Änderungen zu commiten gibt
        if git diff --staged --quiet; then
          echo "Keine Änderungen im wasm/ Ordner."
        else
          git commit -m "chore: Update WebAssembly build from GitHub Actions [skip ci]"
          git push
        fi
