name: Build and Deploy WASM

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: wasm32-unknown-unknown
        components: rust-src

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install wasm-pack
      run: |
        curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Build WASM
      run: |
        wasm-pack build --target web --release --out-name fhe_eva_core --out-dir wasm

    - name: Optimize WASM
      run: |
        which wasm-opt || npm install -g binaryen
        wasm-opt -Oz \
          --all-features \
          --strip-debug \
          --strip-producers \
          -o wasm/fhe_eva_core_bg.wasm \
          wasm/fhe_eva_core_bg.wasm
        echo "WASM size: $(wc -c < wasm/fhe_eva_core_bg.wasm) bytes"

    - name: Test WASM
      run: |
        cd wasm
        echo "Testing WASM module..."
        node -e "const mod = require('./fhe_eva_core.js'); console.log('WASM module loaded successfully');"

    - name: Upload WASM artifact
      uses: actions/upload-artifact@v4  # ‚Üê GE√ÑNDERT zu v4!
      with:
        name: fhe-eva-core-wasm
        path: wasm/
        retention-days: 7

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download WASM artifact
      uses: actions/download-artifact@v4  # ‚Üê GE√ÑNDERT zu v4!
      with:
        name: fhe-eva-core-wasm
        path: dist/

    - name: Create example HTML
      run: |
        cat > dist/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>FHE Eva Core - Homomorphic Encryption</title>
            <meta charset="utf-8">
            <style>
                body { font-family: monospace; margin: 40px; }
                .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
            </style>
        </head>
        <body>
            <h1>FHE Eva Core üöÄ</h1>
            <p>Fully Homomorphic Encryption WebAssembly Runtime</p>
            <div id="output"></div>
            
            <script type="module">
                import init, { ntt_1024 } from './fhe_eva_core.js';
                
                async function run() {
                    await init();
                    const output = document.getElementById('output');
                    
                    output.innerHTML += '<div class="result">Loading WASM...</div>';
                    
                    const start = performance.now();
                    const result = ntt_1024();
                    const duration = performance.now() - start;
                    
                    output.innerHTML += `
                        <div class="result">
                            <strong>‚úÖ NTT 1024 Test Successful!</strong><br>
                            Result: ${result.toFixed(4)}<br>
                            Execution time: ${duration.toFixed(2)}ms
                        </div>
                    `;
                    
                    output.innerHTML += '<div class="result">üéâ FHE Runtime is working!</div>';
                }
                
                run().catch(console.error);
            </script>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4  # ‚Üê Optional: Auch zu v4 updaten

    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v3  # Diese ist noch aktuell

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4  # ‚Üê Auch zu v4 updaten
