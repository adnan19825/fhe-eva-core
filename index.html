<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Eva Core | Production Runtime</title>
    <style>
        /* Modern Enterprise Design */
        :root { --bg: #0d1117; --card: #161b22; --accent: #238636; --text: #c9d1d9; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; margin: 0; }
        .card { background: var(--card); border: 1px solid #30363d; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        button { background: #2ea043; color: white; border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 6px; font-size: 1rem; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
        button:hover:not(:disabled) { background: #22863a; }
        button:disabled { background: #333; opacity: 0.7; cursor: not-allowed; }
        #terminal { background: black; color: #39ff14; font-family: monospace; padding: 10px; height: 180px; overflow-y: auto; border-radius: 4px; font-size: 0.8rem; border: 1px solid #30363d; }
        .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; margin-top: 10px; }
        .cell { aspect-ratio: 1; background: #21262d; border-radius: 2px; }
        h1 { margin: 0 0 10px 0; font-size: 1.6rem; }
        .metric { font-size: 0.9rem; color: #8b949e; }
        .success { color: #2ea043; font-weight: bold; }
        .error { color: #f85149; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h1>FHE Eva Core <span style="color:#2ea043">v6.4</span></h1>
    <div class="metric">Deployment Status: <span id="status">Connecting to WASM...</span></div>
</div>

<div class="card">
    <div class="metric">FHE Kernel Control (Radix-4)</div>
    <button id="btn-init" onclick="doInit()" disabled>1. INITIALIZE & KEYGEN (4096)</button>
    <button id="btn-run" onclick="doRun()" disabled>2. EXECUTE NTT TRANSFORM</button>
    <button id="btn-bench" onclick="doBench()" disabled>3. STRESS BENCHMARK (x50 Cycles)</button>
</div>

<div class="card">
    <div class="metric">Live Memory Map (Polynom-Koeffizienten)</div>
    <div class="grid" id="viz"></div>
</div>

<div class="card">
    <div class="metric">Runtime Observability Console</div>
    <div id="terminal">System Ready. Awaiting WASM module.</div>
</div>

<script type="module">
    // Importiert das WASM. Name 'fhe_eva_core' muss stimmen (GitHub Default).
    import init, { FheContext } from './pkg/fhe_eva_core.js';

    let context = null;
    const POLYNOMIAL_SIZE = 4096; // Echte Größe! 4096 Elemente.

    function log(msg, isError = false) {
        const t = document.getElementById('terminal');
        const className = isError ? 'error' : 'success';
        t.innerHTML += `<div>[${new Date().toLocaleTimeString()}] <span class="${className}">${msg}</span></div>`;
        t.scrollTop = t.scrollHeight;
    }

    // Liest echte Daten aus dem RAM für die Visualisierung
    function updateViz() {
        if(!context) return;
        const grid = document.getElementById('viz');
        grid.innerHTML = '';
        for(let i=0; i<64; i++) {
            const val = context.get_coeff(i); // Echter Wert aus Rust (Radix-4)
            const cell = document.createElement('div');
            cell.className = 'cell';
            
            // Helligkeit basierend auf dem echten Wert für die Visualisierung
            const brightness = (Number(val % 255n) / 255); 
            if(val > 0n) {
                // Grüner Farbverlauf von 20% bis 100% Helligkeit
                cell.style.background = `rgba(46, 160, 67, ${0.2 + 0.8 * brightness})`; 
            }
            grid.appendChild(cell);
        }
    }

    window.doInit = function() {
        log(`[KMS] Allocating ${POLYNOMIAL_SIZE} coefficients...`);
        const start = performance.now();
        
        try {
            // ECHTER CALL: Allokiert Speicher und füllt ihn (Radix-4 Kernel)
            context = FheContext.new(POLYNOMIAL_SIZE);
            const bytes = context.generate_keys();
            
            const end = performance.now();
            log(`[KMS] Keygen complete. ${bytes} bytes in ${(end-start).toFixed(2)}ms.`);
            updateViz();
            
            document.getElementById('btn-init').disabled = true;
            document.getElementById('btn-run').disabled = false;
            document.getElementById('btn-bench').disabled = false;
        } catch(e) {
            log(`[ERROR] Initialization failed: ${e.message}`, true);
        }
    };

    window.doRun = function() {
        if(!context) return log("[ERROR] Runtime not initialized. Run Step 1.", true);
        
        log("[NTT] Starting Radix-4 Transform...");
        const start = performance.now();
        
        try {
            // ECHTER CALL: Radix-4 Berechnung
            context.run_ntt();
            
            const end = performance.now();
            log(`[NTT] Transform complete. Execution time: ${(end-start).toFixed(2)}ms`);
            updateViz(); // Matrix ändert sich basierend auf Berechnung
        } catch(e) {
            log(`[ERROR] NTT Execution failed: ${e.message}`, true);
        }
    };

    window.doBench = function() {
        if(!context) return log("[ERROR] Runtime not initialized. Run Step 1.", true);

        log("[BENCHMARK] Starting Stress Test (50 cycles)...");
        let total = 0;
        
        // setTimeout, um die UI nicht komplett zu blockieren
        setTimeout(() => {
            try {
                for(let i=0; i<50; i++) {
                    const t0 = performance.now();
                    context.run_ntt(); // Echte Last auf CPU
                    total += (performance.now() - t0);
                }
                const avg = total / 50;
                log(`[BENCHMARK] Complete. Avg Execution: <span style="color:#FFD700">${avg.toFixed(2)}ms</span> (50 runs).`);
                updateViz();
            } catch(e) {
                log(`[ERROR] Benchmark failed: ${e.message}`, true);
            }
        }, 50);
    };

    async function main() {
        try {
            await init();
            document.getElementById('status').innerHTML = '<span class="success">WASM Kernel Loaded & Ready</span>';
            document.getElementById('btn-init').disabled = false;
            log("Core v6.4 (Radix-4) initialized.");
            
            // Leere Grid init
            const grid = document.getElementById('viz');
            for(let i=0; i<64; i++) {
                let c = document.createElement('div'); c.className='cell'; grid.appendChild(c);
            }
        } catch(e) {
            document.getElementById('status').innerHTML = '<span class="error">WASM Load Error</span>';
            log(`[FATAL] Failed to load FHE Core: ${e.message}.`, true);
        }
    }

    main();
</script>
</body>
</html>
